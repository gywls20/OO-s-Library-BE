<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default_layout}">
<head>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <style>
        .material-symbols-outlined {
            font-variation-settings:
                    'FILL' 0,
                    'wght' 200,
                    'GRAD' 200,
                    'opsz' 24
        }
    </style>
    <style>
        .book-gallery {
            display: flex;
            flex-wrap: wrap;
            justify-content: center; /* ì•„ì´í…œë“¤ì„ ì¤‘ì•™ ì •ë ¬í•©ë‹ˆë‹¤. */
            gap: 10px; /* ê° ì•„ì´í…œ ì‚¬ì´ì˜ ê°„ê²© */
        }

        .book-item {
            flex: 1 0 18%; /* ê¸°ë³¸ì ìœ¼ë¡œ í•œ ì¤„ì— 5ê°œ ì•„ì´í…œ */
            border: 1px solid #ddd; /* ì‹œê°ì ìœ¼ë¡œ êµ¬ë¶„í•˜ê¸° ìœ„í•œ í…Œë‘ë¦¬ */
            padding: 10px;
            box-sizing: border-box;
            max-width: 340px; /* ì•„ì´í…œì˜ ìµœëŒ€ ë„ˆë¹„ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤. */
            margin: 10px; /* ì•„ì´í…œ ì£¼ë³€ì— ì—¬ë°±ì„ ì¶”ê°€í•©ë‹ˆë‹¤. */
        }
        .book_center{
            justify-content: center; /* ì•„ì´í…œë“¤ì„ ì¤‘ì•™ ì •ë ¬í•©ë‹ˆë‹¤. */
        }
        /* í™”ë©´ í¬ê¸°ê°€ 768px ~ 1199pxì¼ ë•Œ í•œ ì¤„ì— 3ê°œ ì•„ì´í…œ */
        @media (max-width: 1199px) {
            .book-item {
                flex: 1 0 30%;
            }
        }

        /* í™”ë©´ í¬ê¸°ê°€ 767px ì´í•˜ì¼ ë•Œ í•œ ì¤„ì— 1ê°œ ì•„ì´í…œ */
        @media (max-width: 670px) {
            .book-item {
                max-width: none; /* ì‘ì€ í™”ë©´ì—ì„œëŠ” ë„ˆë¹„ ì œí•œì„ í•´ì œí•©ë‹ˆë‹¤. */
                flex-basis: 100%; /* ì•„ì´í…œì´ í™”ë©´ ì „ì²´ ë„ˆë¹„ë¥¼ ì°¨ì§€í•˜ë„ë¡ ì„¤ì •í•©ë‹ˆë‹¤. */
            }
        }
        .header-container {
            display: flex;
            align-items: center;
            gap: 10px; /* ì•„ì´ì½˜ê³¼ ì œëª© ì‚¬ì´ì˜ ê°„ê²© */
            padding-left: 20px; /* ì™¼ìª½ì—ì„œë¶€í„°ì˜ ê°„ê²© */
        }
        .book-container{
            display: flex;
            gap: 10px; /* ì•„ì´ì½˜ê³¼ ì œëª© ì‚¬ì´ì˜ ê°„ê²© */

        }
        .header-container span {
            font-size: 50px; /* ì•„ì´ì½˜ í¬ê¸° ì¡°ì ˆ */
        }
        .header-container a{
            text-decoration: none; /* ë§í¬ì˜ ë°‘ì¤„ ì œê±° */
        }
        .header-container h1 {
            margin: 0; /* ê¸°ë³¸ ë§ˆì§„ ì œê±° */
        }
        .delete-button-container a{
            text-decoration: none; /* ë§í¬ì˜ ë°‘ì¤„ ì œê±° */
        }
        .eBook-container a {
            display: flex; /* flexbox ë ˆì´ì•„ì›ƒ ì‚¬ìš© */
            align-items: center; /* ìˆ˜ì§ ë°©í–¥ ê°€ìš´ë° ì •ë ¬ */
            justify-content: center; /* ìˆ˜í‰ ë°©í–¥ ê°€ìš´ë° ì •ë ¬ */
            text-decoration: none; /* a íƒœê·¸ ê¸°ë³¸ ë°‘ì¤„ ìŠ¤íƒ€ì¼ ì œê±° */
        }

        .eBook-container a .material-symbols-outlined {
            margin-right: 8px; /* ì•„ì´ì½˜ê³¼ í…ìŠ¤íŠ¸ ì‚¬ì´ ê°„ê²© ì¡°ì • */
        }
    </style>
</head>
<body>
    <div layout:fragment="content">
        <br>
        <div class="header-container">
            <span class="material-symbols-outlined">Book</span>
            <h1>My Library </h1>
            <h1> |  </h1>
            <h1><a th:href="@{../calendar/{pk}(pk=${session.myLibraryPk})}" class="material-symbols-outlined">MyCalendar</a></h1>
        </div>
        <br>
        <div class="book-gallery">
            <div th:each="book, bookStat : ${bookList}" class="book-item">
                <div class="book_center">
                    <hr>
                    <div class="book-container">
                        <!-- Button trigger modal -->
                        <button type="button" class="btn btn-light open-modal" data-bs-toggle="modal"
                                th:attr="data-bs-target='#exampleModal' + ${bookStat.index},
                            data-book-pk=${book.bookPk},
                            data-index=${bookStat.index},
                            data-user=${session.pk},
                            data-name=${session.name}">
                            <img th:src="${book.coverImagePath}" alt="ë¶ì»¤ë²„">
                        </button>

                        <div class="delete-button-container">
                            <a href="javascript:void(0)" class="material-symbols-outlined" id="deleteBookBtn" onclick="deleteBook(this)" th:attr="data-book-pk=${book.bookPk}, my-library-pk=${session.myLibraryPk}">Delete</a>
                        </div>
                    </div>
                    <div class="eBook-container">
                        <a th:href="@{../eBook(book_plus=${book.bookPlusPk},book_pk=${book.bookPk})}" class="material-symbols-outlined" >Menu_Book<p>ë³´ëŸ¬ê°€ê¸°</p></a>
                    </div>
                    <p th:text="${book.bookTitle}" readonly/>
                    <p th:text="${book.bookAuthor}" readonly/>
                    <p th:text="${book.bookCategory}" readonly/>
                    <p th:text="${book.bookContent}" readonly/>
                    <p th:text="${book.bookPrice}" readonly/>
                    <p th:text="${book.bookPublisher}" readonly/>
                    <p th:text="${book.bookPublishDate}" readonly/>
                    <hr>
                </div>

                <!-- Modal -->
                <!-- Modal -->
                <div class="modal fade" th:id="'exampleModal' + ${bookStat.index}" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h1 class="modal-title fs-5" id="exampleModalLabel">Comment List</h1>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div th:id="'commentsContainer' + ${bookStat.index}"> <!-- ì±…ë“¤ ë§ˆë‹¤ ì¸ë±ìŠ¤ ë¶€ì—¬ -->
                                    <!-- ì½”ë©˜íŠ¸ê°€ í‘œì‹œë˜ëŠ” ê³³ -->
                                </div>
                                <button id="searchMoreNotify" class="btn btn-outline-primary btn-block col-sm-10 mx-auto" style="width: 465px">ë”ë³´ê¸°</button><br>
                                <!-- ì½”ë©˜íŠ¸ ì‘ì„± í¼-->
                                <br>
                                <div class="card shadow border-0 rounded-4 mb-5">
                                    <div class="card-body p-5">
                                        <h4 style="text-align: left">ì½”ë©˜íŠ¸ ì‘ì„±ğŸ“ƒ</h4>
                                        <div class="mb-5">
                                            <div class="d-flex align-items-center mb-4">
                                                <form id="commentForm" th:action="@{/comments/insert}" method="post" onsubmit="submitForm(event);">
                                                    <input type="hidden" th:name="book_pk" th:value="${book.bookPk}">
                                                    <input type="hidden" th:name="member_pk" th:value="${session.pk}">
                                                    <!--<div>
                                                        <p type="text" id="member_pk" name="member_pk" th:value="${session.pk}" th:text="${session.name}" required>
                                                    </div>-->
                                                    <div class="form-floating mb-3">
                                                        <input class="form-control" id="comment_title" name="comment_title" type="text" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì‹œì˜¤" required />
                                                        <label for="comment_title">ì œëª©</label>
                                                    </div>
                                                    <div class="form-floating mb-3">
                                                        <textarea class="form-control" id="comment_content" name="comment_content" style="height: 10rem" cols="50" rows="5" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì‹œì˜¤" required></textarea>
                                                        <label for="comment_content">ë‚´ìš©</label>
                                                    </div>
                                                    <button type="submit" class="btn btn-outline-primary" id="submitCommentBtn" >ë“±ë¡</button>
                                                    <button type="reset" class="btn btn-outline-secondary" >ì·¨ì†Œ</button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-primary" style="background-color: dodgerblue; color: white; border: dodgerblue" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

<script>
        //urlì—ì„œ my_library_pk ê°’ ê°€ì ¸ì˜¤ê¸°
        var url = window.location.href;
        const lastSegment = url.split('/').pop();

        //document.getElementById('commentForm').addEventListener('submit', function(e) {
        //function submitForm(e) {
        document.querySelectorAll('.modal').forEach(function(modal) {
        modal.querySelector('form').addEventListener('submit', function(e) {
        console.log(e);
        e.preventDefault(); // ê¸°ë³¸ í¼ ì œì¶œ ë™ì‘ì„ ë°©ì§€

        //var form = document.getElementById('commentForm');
        var form = e.target; // í˜„ì¬ ì´ë²¤íŠ¸ê°€ ë°œìƒí•œ í¼ ì°¸ì¡°
        var formData = new FormData(form); // í¼ ë°ì´í„° ìˆ˜ì§‘
        formData.append('my_library_pk', lastSegment);
        console.log(formData);
        console.log(form);

        fetch(form.action, {
        method: 'POST',
        body: formData
        })
        .then(response => {
        if(response.ok) {
        // ì„±ê³µì ìœ¼ë¡œ ë°ì´í„°ê°€ ì²˜ë¦¬ë˜ì—ˆì„ ë•Œ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
        alert("ì½”ë©˜íŠ¸ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
        window.location.reload();
        } else {
        // ì„œë²„ì—ì„œ ì˜¤ë¥˜ ì‘ë‹µì´ ì˜¬ ê²½ìš° ì²˜ë¦¬
        alert('ì½”ë©˜íŠ¸ ë“±ë¡ì´ ë¶ˆê°€í•©ë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”');
        }
        })
        .catch(error => console.error('Error:', error));

        //ì €ì¥ í›„ ë¦¬ì…‹
        document.getElementById("commentForm").reset();
        });
        });

        //ì½”ë©˜íŠ¸ ë¦¬ìŠ¤íŠ¸ + í˜ì´ì§• ì²˜ë¦¬
        $(document).ready(function() {
        $('.open-modal').click(function () {
        // í˜ì´ì§€ ë²ˆí˜¸ ì´ˆê¸°í™”
        window.pageNum = 1;

        // í•„ìš”í•œ ë°ì´í„° ë¡œë“œ
        var pageSize = 3;     //3ê°œì”© ë¡œë”©
        var user = $(this).data('user');
        var name = $(this).data('name');
        var bookPk = $(this).data('book-pk');
        var myLibraryPk = lastSegment;
        var index = $(this).data('index'); // ì¸ë±ìŠ¤
        console.log(user);

        // commentsContainer ë³€ìˆ˜ë¥¼ ì—¬ê¸°ì—ì„œ ì´ˆê¸°í™”
        var commentsContainer = $('#commentsContainer' + index);
        console.log(commentsContainer);

        // commentsContainer ë‚´ìš© ì´ˆê¸°í™”
        //commentsContainer.empty();

        // ëŒ“ê¸€ ë¡œë“œ í•¨ìˆ˜ í˜¸ì¶œ
        loadComments(window.pageNum);

        // ë”ë³´ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì´ˆê¸°í™”
        $('#searchMoreNotify').off('click').on('click', function(){
        window.pageNum++; // í˜ì´ì§€ ë²ˆí˜¸ ì¦ê°€
        loadComments(window.pageNum);
        });

        function loadComments(pageNum) {
        $.ajax({
        url: '/comments/list',
        type: 'POST',
        contentType: 'application/json',    // ì„œë²„ë¡œ ë³´ë‚´ëŠ” ë°ì´í„°ì˜ íƒ€ì…
        dateType: JSON,                     // ì„œë²„ë¡œë¶€í„° ë°›ì•„ì˜¬ ë°ì´í„°ì˜ íƒ€ì…
        data: JSON.stringify({pageNum: pageNum, pageSize: pageSize, bookPk: bookPk, myLibraryPk: myLibraryPk}),
        success: function (data) {
        console.log(data);
        if (window.pageNum === 1) { // ì²« í˜ì´ì§€ì¼ ê²½ìš°, ì½”ë©˜íŠ¸ ì»¨í…Œì´ë„ˆë¥¼ ì´ˆê¸°í™”
        $('#commentsContainer' + index).empty();
        }

        const commentsContainer = document.getElementById('commentsContainer' + index);
        data.forEach(function(comment) {
        var commentHtml = `<div class="card shadow border-0 rounded-4 mb-5">
        <div class="col text-center text-lg-start mb-4 mb-lg-0">
            <div class="bg-light p-4 rounded-4">
                <div class="text-primary fw-bolder mb-2 btn-sm">
                    <div style="text-align: right">
                        <button style="background: none; border: none; cursor: pointer; outline: none; padding: 0; text-align: right;" class="fas fa-heart"
                                data-liked="false" onclick="likeComment(this ,${comment.comment_pk}, ${comment.member_pk})"></button>&nbsp;&nbsp;
                        <button style="background: none; border: none; cursor: pointer; outline: none; padding: 0; text-align: right;" class="fas fa-flag"
                                onclick="reportComment(${comment.comment_pk}, ${comment.member_pk})"></button><br>
                    </div>
                    <div style="display: flex; align-items: center;">
                        <img class="img-fluid" src="https://ssl.pstatic.net/static/pwe/address/img_profile.png" width="40" height="40" style="margin-right: 10px;">
                        <p style="color: black; font-size: large; margin: 0;">${name}</p>
                    </div><br>
                    <div class="small text-muted" style="text-align: right">
                        ${comment.created_date} <br>
                        ${comment.modified_date ? `ìˆ˜ì • ì¼ì : <br>${comment.modified_date} <br>` : ''}
                    </div><br>
                    <div>
                        <div style="text-align: left; font-size: x-large; font-weight: bold; color: black">${comment.comment_title}</div>
                        <div style="text-align: left; margin-left: 20px; color: black">${comment.comment_content}</div>
                    </div><br><br><br>`;
                    // ì‚¬ìš©ì IDì™€ ëŒ“ê¸€ ì‘ì„±ì IDê°€ ê°™ì„ ê²½ìš°ì—ë§Œ ìˆ˜ì • ë° ì‚­ì œ ë²„íŠ¼ ì¶”ê°€
                    if (user === comment.member_pk) {
                    commentHtml += `<div style="text-align: right;">
                    <input type="button" class="btn btn-primary btn-sm" value="ìˆ˜ì •" onclick="openEditModal(${comment.comment_pk})">
                    <input type="button" class="btn btn-secondary btn-sm" value="ì‚­ì œ" onclick="isDelete(${comment.comment_pk})">
                </div>`;
                    }
                    commentHtml += `</div> <!-- ì—¬ê¸°ëŠ” ë‚´ìš© divì˜ ë‹«ëŠ” íƒœê·¸ -->
            </div>
        </div>
    </div>`;

        // commentsContainerì— ëŒ“ê¸€ ìš”ì†Œ ì¶”ê°€
        $(commentsContainer).append(commentHtml);

        });
        // ë”ë³´ê¸° ë²„íŠ¼ ë³´ì´ê¸°/ìˆ¨ê¸°ê¸° ì²˜ë¦¬
        if(data.length < pageSize) {
        $('#searchMoreNotify[data-index="' + index + '"]').hide();
        }else {
        $('#searchMoreNotify[data-index="' + index + '"]').show(); // ë” ë¶ˆëŸ¬ì˜¬ ë°ì´í„°ê°€ ìˆì„ ê²½ìš° "ë”ë³´ê¸°" ë²„íŠ¼ì„ ë‹¤ì‹œ ë³´ì´ê²Œ í•©ë‹ˆë‹¤.
        }
        },
        error: function (err) {
        console.log('Error:', err);
        }
        });
        }

        });
        });

        //ì½”ë©˜íŠ¸ ìˆ˜ì •
        function openEditModal(comment_pk) {
        console.log(comment_pk);
        var url = "/comments/updateComment?comment_pk=" + comment_pk;
        var width = 600; // ì°½ì˜ ë„ˆë¹„
        var height = 400; // ì°½ì˜ ë†’ì´
        //ì˜¤í”ˆ ì‹œ í™”ë©´ ê°€ìš´ë°ì— ìœ„ì¹˜
        var left = window.screen.width / 2 - width / 2;
        var top = window.screen.height / 2 - height / 2;

        //ë¯¸ë‹ˆì°½ ì˜¤í”ˆ
        window.open(url, "Comment Edit", "width=" + width + ",height=" + height + ",top=" + top + ",left=" + left);
        //window.open(url, "Comment Edit", "width=600,height=400");
        }

        //ì‚­ì œ í™•ì¸ ì—¬ë¶€
        function isDelete(comment_pk) {
        var is_delete = confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
        if (is_delete) {
        deleteComment(comment_pk)
        }
        }
        // ëŒ“ê¸€ ì‚­ì œ
        function deleteComment(comment_pk) {
        console.log(`Deleting comment ${comment_pk}`);
        fetch(`/comments/delete/${comment_pk}`, {
        method: 'DELETE'
        })
        .then(response => {
        if(response.ok) {
        // ìš”ì²­ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ë©´, í•´ë‹¹ ëŒ“ê¸€ ìš”ì†Œë¥¼ ì œê±°
        const commentElement = document.getElementById(`comment-${comment_pk}`);
        if(commentElement) {
        commentElement.remove();
        }
        console.log('ì½”ë©˜íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        alert("ì½”ë©˜íŠ¸ê°€ ì‚­ì œ ë˜ì—ˆìŠµë‹ˆë‹¤.");
        location.reload();

        } else {
        // ì„œë²„ë¡œë¶€í„° ì˜¤ë¥˜ ì‘ë‹µì„ ë°›ì•˜ì„ ë•Œ ì²˜ë¦¬
        console.error('ì½”ë©˜íŠ¸ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
        })
        .catch((error) => {
        console.error('Error:', error);
        });
        }

        //ì¢‹ì•„ìš”
        function likeComment(button, comment_pk, member_pk) {
        const isLiked = button.getAttribute('data-liked') === 'true';

        // ì¢‹ì•„ìš” ìƒíƒœë¥¼ í† ê¸€í•©ë‹ˆë‹¤.
        button.setAttribute('data-liked', !isLiked);

        // ë²„íŠ¼ ìƒ‰ìƒì„ ë³€ê²½í•©ë‹ˆë‹¤.
        button.style.color = !isLiked ? 'red' : 'black'; // ì¢‹ì•„ìš” ìƒíƒœì— ë”°ë¼ ìƒ‰ìƒì„ ë³€ê²½

        // ì ì ˆí•œ ì•¡ì…˜ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
        if (!isLiked) {
        // ì¢‹ì•„ìš” ë“±ë¡
        registerLike(comment_pk, member_pk);
        } else {
        // ì¢‹ì•„ìš” ì·¨ì†Œ
        cancelLike(comment_pk, member_pk);
        }
        }
        //ì¢‹ì•„ìš” ì¶”ê°€
        function registerLike(comment_pk, member_pk) {
        // AJAX ìš”ì²­ì„ í†µí•´ ì„œë²„ì— ì¢‹ì•„ìš” ë“±ë¡ì„ ìš”ì²­í•©ë‹ˆë‹¤.
        fetch(`/comments/likes/${comment_pk}/${member_pk}`, {
        method: 'POST'
        }).then(response => {
        if (!response.ok) {
        throw new Error('Failed to register like');
        }
        console.log('Like registered');
        }).catch(error => {
        console.error('Error:', error);
        });
        }
        //ì¢‹ì•„ìš” ì·¨ì†Œ
        function cancelLike(comment_pk, member_pk) {
        // AJAX ìš”ì²­ì„ í†µí•´ ì„œë²„ì— ì¢‹ì•„ìš” ì·¨ì†Œë¥¼ ìš”ì²­í•©ë‹ˆë‹¤.
        fetch(`/comments/likes/${comment_pk}/${member_pk}`, {
        method: 'DELETE'
        }).then(response => {
        if (!response.ok) {
        throw new Error('Failed to cancel like');
        }
        console.log('Like canceled');
        }).catch(error => {
        console.error('Error:', error);
        });
        }

        //ì‹ ê³ 
        function reportComment(comment_pk, member_pk){
        console.log(comment_pk);
        var url = "/comments/report?comment_pk=" + comment_pk + "&member_pk=" + member_pk;
        var width = 600; // ì°½ì˜ ë„ˆë¹„
        var height = 400; // ì°½ì˜ ë†’ì´
        //ì˜¤í”ˆ ì‹œ í™”ë©´ ê°€ìš´ë°ì— ìœ„ì¹˜
        var left = window.screen.width / 2 - width / 2;
        var top = window.screen.height / 2 - height / 2;

        //ë¯¸ë‹ˆì°½ ì˜¤í”ˆ
        window.open(url, "Comment Edit", "width=" + width + ",height=" + height + ",top=" + top + ",left=" + left);
        }
        </script>



        <script th:inline="javascript">


            function deleteBook(element) {
                const bookPk = element.getAttribute('data-book-pk');
                const myLibraryPk = element.getAttribute('my-library-pk');

                $.ajax({
                    url: '/bookPlus',
                    type: 'DELETE',
                    data: {
                        bookPk: bookPk,
                        myLibraryPk: myLibraryPk
                    },
                    success: function(response) {
                        alert(response);
                        // í•„ìš”í•œ ê²½ìš°, ì„±ê³µ í›„ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ë˜ëŠ” ë¦¬ë‹¤ì´ë ‰íŠ¸
                        location.reload();
                        //window.location.href = '/someOtherPage';
                    },
                    error: function(xhr, status, error) {
                        // ì—ëŸ¬ ì²˜ë¦¬
                        alert("ì—ëŸ¬ ë°œìƒ");
                    }
                });
            }
        </script>
    </div>
</body>
</html>